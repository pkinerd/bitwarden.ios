name: Debug Build, Test & Simulator Artifact

on:
  workflow_dispatch:
    inputs:
      app:
        description: "App to build"
        required: true
        default: "password-manager"
        type: choice
        options:
          - password-manager
          - authenticator
          - both
      run-tests:
        description: "Run tests after building"
        required: true
        default: true
        type: boolean
      xcode-version:
        description: "Xcode version override - e.g. '15.2'"
        type: string
      simulator-name:
        description: "Simulator name override - e.g. 'iPhone 16 Pro'"
        type: string
      simulator-version:
        description: "Simulator iOS version override - e.g. '18.0.1'"
        type: string
      compiler-flags:
        description: "Compiler Flags - e.g. 'DEBUG_MENU FEATURE2'"
        type: string

env:
  MINT_LINK_PATH: .mint/bin
  MINT_PATH: .mint/lib

jobs:
  # ---------------------------------------------------------------------------
  # Password Manager: Debug Build + Test + Simulator .app Artifact
  # ---------------------------------------------------------------------------
  password-manager:
    name: "PM: Debug Build & Test"
    if: ${{ inputs.app == 'password-manager' || inputs.app == 'both' }}
    runs-on: macos-26
    timeout-minutes: 60
    permissions:
      contents: read
    env:
      _SIMULATOR_NAME: ${{ inputs.simulator-name }}
      _SIMULATOR_VERSION: ${{ inputs.simulator-version }}
      _XCODE_VERSION: ${{ inputs.xcode-version }}
      _COMPILER_FLAGS: ${{ inputs.compiler-flags }}
      _BUILD_RESULT_BUNDLE_PATH: build/bwpm-build.xcresult
      _TESTS_RESULT_BUNDLE_PATH: build/bwpm-tests.xcresult

    steps:
      - name: Check out repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Optimize macOS Runner
        uses: ./.github/actions/macos-runner-tuneup

      - name: Read Xcode version and simulator configuration from file if not provided
        run: |
          if [ -z "$_XCODE_VERSION" ]; then
            echo "_XCODE_VERSION=$(cat .xcode-version | tr -d '\n')" >> "$GITHUB_ENV"
          fi
          if [ -z "$_SIMULATOR_NAME" ]; then
            echo "_SIMULATOR_NAME=$(cat .test-simulator-device-name | tr -d '\n')" >> "$GITHUB_ENV"
          fi
          if [ -z "$_SIMULATOR_VERSION" ]; then
            echo "_SIMULATOR_VERSION=$(cat .test-simulator-ios-version | tr -d '\n')" >> "$GITHUB_ENV"
          fi

      - name: Set Xcode version
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: ${{ env._XCODE_VERSION }}

      - name: Configure Ruby
        uses: ruby/setup-ruby@44511735964dcb71245e7e55f72539531f7bc0eb # v1.257.0
        with:
          bundler-cache: true

      - name: Cache Mint packages
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: .mint
          key: ${{ runner.os }}-mint-${{ hashFiles('**/Mintfile') }}
          restore-keys: |
            ${{ runner.os }}-mint-

      - name: Cache SPM packages
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: build/DerivedData/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Update local config
        run: |
          ./Scripts/update_test_local_config.sh "${_COMPILER_FLAGS}"

      - name: Install Homebrew Dependencies and run bootstrap.sh
        run: |
          brew update
          brew bundle
          ./Scripts/bootstrap.sh

      - name: Boot Simulator
        id: boot-simulator
        uses: ./.github/actions/boot-simulator
        with:
          simulator-name: ${{ env._SIMULATOR_NAME }}
          simulator-version: ${{ env._SIMULATOR_VERSION }}

      - name: "Build: Password Manager (Debug / Simulator)"
        env:
          _SIMULATOR_ID: ${{ steps.boot-simulator.outputs.simulator-id }}
        run: |
          python Scripts/pyeetd/main.py & PYEETD_PID=$!
          xcrun xcodebuild build-for-testing \
            -workspace Bitwarden.xcworkspace \
            -scheme Bitwarden \
            -configuration Debug \
            -destination "platform=iOS Simulator,id=$_SIMULATOR_ID" \
            -derivedDataPath build/DerivedData \
            -resultBundlePath "$_BUILD_RESULT_BUNDLE_PATH" \
            -quiet
          kill "$PYEETD_PID"

      - name: "Test: Password Manager"
        if: ${{ inputs.run-tests }}
        env:
          _SIMULATOR_ID: ${{ steps.boot-simulator.outputs.simulator-id }}
        run: |
          python Scripts/pyeetd/main.py & PYEETD_PID=$!
          xcrun xcodebuild test-without-building \
            -workspace Bitwarden.xcworkspace \
            -scheme Bitwarden \
            -configuration Debug \
            -destination "platform=iOS Simulator,id=$_SIMULATOR_ID" \
            -resultBundlePath "$_TESTS_RESULT_BUNDLE_PATH" \
            -derivedDataPath build/DerivedData \
            -test-timeouts-enabled yes \
            -maximum-test-execution-time-allowance 1 \
            -quiet
          kill "$PYEETD_PID"

      - name: Print Test Summary
        if: ${{ inputs.run-tests && always() }}
        run: |
          if [ -d "$_TESTS_RESULT_BUNDLE_PATH" ]; then
            xcresultparser -o cli "$_TESTS_RESULT_BUNDLE_PATH"
            echo "# Test Summary" >> "$GITHUB_STEP_SUMMARY"
            xcresultparser -f -o txt "$_TESTS_RESULT_BUNDLE_PATH" | grep "Number of" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: "Package: Simulator .app artifact"
        run: |
          APP_PATH="build/DerivedData/Build/Products/Debug-iphonesimulator/Bitwarden.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "::error::Bitwarden.app not found at $APP_PATH"
            exit 1
          fi
          mkdir -p build/artifacts
          cd build/DerivedData/Build/Products/Debug-iphonesimulator
          zip -r -q ../../../../artifacts/Bitwarden-Simulator.zip Bitwarden.app

      - name: "Upload: Simulator .app"
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: Bitwarden-Simulator-Debug
          path: build/artifacts/Bitwarden-Simulator.zip
          if-no-files-found: error

      - name: "Upload: Test reports"
        if: ${{ inputs.run-tests && always() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: pm-test-reports
          compression-level: 9
          path: |
            ${{ env._TESTS_RESULT_BUNDLE_PATH }}
            ${{ env._BUILD_RESULT_BUNDLE_PATH }}

  # ---------------------------------------------------------------------------
  # Authenticator: Debug Build + Test + Simulator .app Artifact
  # ---------------------------------------------------------------------------
  authenticator:
    name: "Auth: Debug Build & Test"
    if: ${{ inputs.app == 'authenticator' || inputs.app == 'both' }}
    runs-on: macos-26
    timeout-minutes: 60
    permissions:
      contents: read
    env:
      _SIMULATOR_NAME: ${{ inputs.simulator-name }}
      _SIMULATOR_VERSION: ${{ inputs.simulator-version }}
      _XCODE_VERSION: ${{ inputs.xcode-version }}
      _COMPILER_FLAGS: ${{ inputs.compiler-flags }}
      _BUILD_RESULT_BUNDLE_PATH: build/bwa-build.xcresult
      _TESTS_RESULT_BUNDLE_PATH: build/bwa-tests.xcresult

    steps:
      - name: Check out repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Optimize macOS Runner
        uses: ./.github/actions/macos-runner-tuneup

      - name: Read Xcode version and simulator configuration from file if not provided
        run: |
          if [ -z "$_XCODE_VERSION" ]; then
            echo "_XCODE_VERSION=$(cat .xcode-version | tr -d '\n')" >> "$GITHUB_ENV"
          fi
          if [ -z "$_SIMULATOR_NAME" ]; then
            echo "_SIMULATOR_NAME=$(cat .test-simulator-device-name | tr -d '\n')" >> "$GITHUB_ENV"
          fi
          if [ -z "$_SIMULATOR_VERSION" ]; then
            echo "_SIMULATOR_VERSION=$(cat .test-simulator-ios-version | tr -d '\n')" >> "$GITHUB_ENV"
          fi

      - name: Set Xcode version
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: ${{ env._XCODE_VERSION }}

      - name: Configure Ruby
        uses: ruby/setup-ruby@44511735964dcb71245e7e55f72539531f7bc0eb # v1.257.0
        with:
          bundler-cache: true

      - name: Cache Mint packages
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: .mint
          key: ${{ runner.os }}-mint-${{ hashFiles('**/Mintfile') }}
          restore-keys: |
            ${{ runner.os }}-mint-

      - name: Cache SPM packages
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: build/DerivedData/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Update local config
        run: |
          ./Scripts-bwa/update_test_local_config.sh "${_COMPILER_FLAGS}"

      - name: Install Homebrew Dependencies and run bootstrap.sh
        run: |
          brew update
          brew bundle
          ./Scripts/bootstrap.sh

      - name: Boot Simulator
        id: boot-simulator
        uses: ./.github/actions/boot-simulator
        with:
          simulator-name: ${{ env._SIMULATOR_NAME }}
          simulator-version: ${{ env._SIMULATOR_VERSION }}

      - name: "Build: Authenticator (Debug / Simulator)"
        env:
          _SIMULATOR_ID: ${{ steps.boot-simulator.outputs.simulator-id }}
        run: |
          python Scripts/pyeetd/main.py & PYEETD_PID=$!
          xcrun xcodebuild build-for-testing \
            -workspace Bitwarden.xcworkspace \
            -scheme Authenticator \
            -configuration Debug \
            -destination "platform=iOS Simulator,id=$_SIMULATOR_ID" \
            -derivedDataPath build/DerivedData \
            -resultBundlePath "$_BUILD_RESULT_BUNDLE_PATH" \
            -quiet
          kill "$PYEETD_PID"

      - name: "Test: Authenticator"
        if: ${{ inputs.run-tests }}
        env:
          _SIMULATOR_ID: ${{ steps.boot-simulator.outputs.simulator-id }}
        run: |
          python Scripts/pyeetd/main.py & PYEETD_PID=$!
          xcrun xcodebuild test-without-building \
            -workspace Bitwarden.xcworkspace \
            -scheme Authenticator \
            -configuration Debug \
            -destination "platform=iOS Simulator,id=$_SIMULATOR_ID" \
            -resultBundlePath "$_TESTS_RESULT_BUNDLE_PATH" \
            -derivedDataPath build/DerivedData \
            -test-timeouts-enabled yes \
            -maximum-test-execution-time-allowance 1 \
            -quiet
          kill "$PYEETD_PID"

      - name: Print Test Summary
        if: ${{ inputs.run-tests && always() }}
        run: |
          if [ -d "$_TESTS_RESULT_BUNDLE_PATH" ]; then
            xcresultparser -o cli "$_TESTS_RESULT_BUNDLE_PATH"
            echo "# Test Summary" >> "$GITHUB_STEP_SUMMARY"
            xcresultparser -f -o txt "$_TESTS_RESULT_BUNDLE_PATH" | grep "Number of" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: "Package: Simulator .app artifact"
        run: |
          APP_PATH="build/DerivedData/Build/Products/Debug-iphonesimulator/Authenticator.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "::error::Authenticator.app not found at $APP_PATH"
            exit 1
          fi
          mkdir -p build/artifacts
          cd build/DerivedData/Build/Products/Debug-iphonesimulator
          zip -r -q ../../../../artifacts/Authenticator-Simulator.zip Authenticator.app

      - name: "Upload: Simulator .app"
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: Authenticator-Simulator-Debug
          path: build/artifacts/Authenticator-Simulator.zip
          if-no-files-found: error

      - name: "Upload: Test reports"
        if: ${{ inputs.run-tests && always() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: auth-test-reports
          compression-level: 9
          path: |
            ${{ env._TESTS_RESULT_BUNDLE_PATH }}
            ${{ env._BUILD_RESULT_BUNDLE_PATH }}
